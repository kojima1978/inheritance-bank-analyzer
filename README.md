# 相続税通帳分析システム (Inheritance Tax Bank Analyzer) v2.0

## 概要
OCR済み通帳CSVを読み込み、相続税調査で注目すべきポイント（名義預金疑い、多額出金、不自然な資金移動）を自動検知し、可視化するローカル完結型アプリケーションです。

## 特徴
- **完全ローカル動作**: インターネット接続不要、データ外部送信なし
- **シンプル操作**: CSVインポート → 自動分析 → 結果表示の3ステップ
- **軽量**: PythonとStreamlitのみで動作
- **自動検知機能**:
  - 口座間資金移動の自動ペアリング（金額・日付近接性で判定）
  - 多額取引フラグ（閾値: 5万円）
  - 残高整合性チェック

## 動作環境
- Python 3.11+ (Python 3.13推奨)
- 推奨ブラウザ: Chrome, Edge

## セットアップ

### 1. 必要なライブラリをインストール
```bash
cd inheritance-bank-analyzer
pip install -r requirements.txt
```

または

```bash
pip install streamlit pandas polars plotly openpyxl kaleido
```

### 2. アプリケーションを起動
```bash
streamlit run main.py
```

または

```bash
python -m streamlit run main.py
```

アプリケーションが起動したら、ブラウザで http://localhost:8501 にアクセスしてください。

### 3. Dockerで実行する場合

```bash
docker compose up -d
```

起動後、http://localhost:8501 にアクセスしてください。

## 使い方

### ステップ1: 案件作成
1. サイドバーから「案件一覧」を選択
2. 「新規案件作成」に案件名を入力（例：山田太郎_相続）
3. 「作成」ボタンをクリック
4. 作成された案件を「選択」ボタンで選択

### ステップ2: CSVインポート
1. サイドバーから「CSVインポート」を選択
2. 通帳CSVファイルをアップロード（形式は下記参照）
3. 口座情報を入力:
   - 銀行名（例: 三菱UFJ銀行）
   - 支店名（例: 青山支店）
   - 口座種別（普通/定期/当座）
   - 口座番号
   - 名義人（例: 山田太郎）
4. 「読み込み・検証」ボタンをクリック
5. プレビューを確認後、「このデータを登録して分析を実行する」をクリック

### ステップ3: 分析結果確認
1. サイドバーから「分析・表示」を選択
2. 3つのタブで結果を確認:
   - **資金移動フロー**: 口座間の資金移動をサンクダイアグラムで可視化
   - **多額取引**: 100万円以上の取引一覧
   - **全取引一覧**: フィルタ・検索可能な全取引データ

## CSVフォーマット

以下の形式のCSVファイルに対応しています。

```csv
銀行名,年月日,摘要,払戻,お預り,差引残高
三菱UFJ銀行,2024-01-15,ATM引出,100000,0,900000
三菱UFJ銀行,2024-01-20,給与振込,0,300000,1200000
```

- **年月日**: YYYY-MM-DD形式
- **払戻**: 出金額（円）
- **お預り**: 入金額（円）
- **差引残高**: 残高（円）

## サンプルデータ

`sample_data/` フォルダに動作確認用のサンプルCSVファイルが含まれています。

- `三菱UFJ銀行_sample.csv`
- `みずほ銀行_sample.csv`

詳細は [sample_data/README.md](sample_data/README.md) を参照してください。

## フォルダ構成

```
inheritance-bank-analyzer/
├── main.py                 # アプリケーションのエントリーポイント
├── pages/                  # Streamlitページ
│   ├── 01_案件一覧.py
│   ├── 02_CSVインポート.py
│   └── 03_分析・表示.py
├── lib/                    # ロジック・DB操作
│   ├── config.py           # 設定（閾値等）
│   ├── db_manager.py       # SQLite管理
│   ├── importer.py         # CSV読み込み・検証
│   └── analyzer.py         # 資金移動検知
├── data/                   # 案件データ保存先（自動生成）
│   └── [案件名]/
│       └── transactions.db
├── sample_data/            # サンプルCSVファイル
├── requirements.txt        # 依存ライブラリ
└── README.md
```

## 設定のカスタマイズ

`lib/config.py` で以下の設定を変更できます。

```python
LARGE_AMOUNT_THRESHOLD = 50_000       # 多額取引の閾値（円）
TRANSFER_DAYS_WINDOW = 3                # 資金移動判定の日付誤差（日）
TRANSFER_AMOUNT_TOLERANCE = 1_000       # 資金移動判定の金額誤差（円）
```

## トラブルシューティング

### Streamlitが起動しない
- Pythonのバージョンを確認してください（3.11以上）
- 必要なライブラリが正しくインストールされているか確認してください

### CSVが読み込めない
- CSVファイルのエンコーディングがUTF-8またはShift-JISであることを確認してください
- カラム名が仕様通りであることを確認してください

### 残高不整合エラーが出る
- OCRの読み取りミスの可能性があります
- CSVファイルの数値を確認してください

## 今後の拡張予定

- LLM（Ollama）による摘要文の自動分類
- 複数年度の比較機能
- 手動修正機能
- PDFレポート出力

## ライセンス
Proprietary

---

**開発環境**: Python 3.13 | Streamlit 1.52+ | Polars 1.37+ | Plotly 6.5+
